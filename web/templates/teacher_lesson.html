<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="apple-touch-icon" sizes="180x180" href="/static/favicons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicons/favicon-16x16.png">
  <link rel="manifest" href="/static/favicons/site.webmanifest">
  <link rel="mask-icon" href="/static/favicons/safari-pinned-tab.svg" color="#5bbad5">
  <link rel="shortcut icon" href="/static/favicons/favicon.ico">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-config" content="/static/favicons/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">

  <title>ACS For Schools | Lesson</title>

  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
  <link href="/static/css/nucleo-icons.css" rel="stylesheet" />
  <link href="/static/css/nucleo-svg.css" rel="stylesheet" />

  <script src="https://kit.fontawesome.com/a9e455503e.js" crossorigin="anonymous"></script>
  <link href="/static/css/nucleo-svg.css" rel="stylesheet" />
  <link rel="stylesheet" href="/static/css/argon-dashboard-tailwind.min.css" />
  <link id="pagestyle" href="/static/css/argon-dashboard.css?v=2.0.4" rel="stylesheet" />
  <script src="https://cdn.lordicon.com/ritcuqlt.js"></script>

  <script src="/static/js/script.js"></script>

  <script type="text/javascript" src="https://MomentJS.com/downloads/moment.js"></script>
  <script type="text/javascript" src="/static/js/moment-timezone-with-data.js.js"></script>
  <script>
    update_timezone()
  </script>

  <link href="/static/css/toast.min.css" rel="stylesheet">
  <script src="/static/js/toast.js"></script>

  <link rel="stylesheet" href="/static/css/style.css">
</head>

<body class="g-sidenav-show bg-gray-100">
  <div class="min-height-300 bg-primary position-absolute w-100"></div>
  <aside
    class="sidenav bg-white navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-4 "
    id="sidenav-main">
    <!-- Logo -->
    <div class="sidenav-header">
      <i class="fas fa-times p-3 cursor-pointer text-secondary opacity-5 position-absolute end-0 top-0 d-xl-none"
        aria-hidden="true" id="iconSidenav"></i>
      <div class="main-logo">
        <img src="/static/img/logo.png" alt="main logo" style="max-width: 100%;">
      </div>
    </div>
    <!-- End Logo -->
    <hr class="horizontal dark mt-0">
    <div class="collapse navbar-collapse  w-auto " id="sidenav-collapse-main">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link " href="/dashboard">
            <div
              class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
              <i class="ni ni-tv-2 text-primary text-sm opacity-10"></i>
            </div>
            <span class="nav-link-text ms-1">Dashboard</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="/teacher-schedule">
            <div
              class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
              <i class="ni ni-calendar-grid-58 text-warning text-sm opacity-10"></i>
            </div>
            <span class="nav-link-text ms-1">Schedule</span>
          </a>
        </li>
        <li class="nav-item mt-3">
          <h6 class="ps-4 ms-2 text-uppercase text-xs font-weight-bolder opacity-6">Account pages</h6>
        </li>
        <li class="nav-item">
          <a class="nav-link " href="/profile">
            <div
              class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
              <i class="ni ni-single-02 text-dark text-sm opacity-10"></i>
            </div>
            <span class="nav-link-text ms-1">Profile (Teacher)</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link " href="/logout">
            <div
              class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
              <i class="ni ni-single-copy-04 text-warning text-sm opacity-10"></i>
            </div>
            <span class="nav-link-text ms-1">Logout</span>
          </a>
        </li>
      </ul>
    </div>
  </aside>
  <main class="main-content position-relative border-radius-lg ">
    <!-- Navbar -->
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl " id="navbarBlur"
      data-scroll="false">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <h6 class="font-weight-bolder text-white mb-0">Lesson</h6>
        </nav>
        <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
          <div class="ms-md-auto pe-md-3 d-flex align-items-center"></div>
          <ul class="navbar-nav  justify-content-end">
            <li class="nav-item d-flex align-items-center">
              <a href="/logout" class="nav-link text-white font-weight-bold px-0">
                <i class="fa fa-user me-sm-1" aria-hidden="true"></i>
                <span class="d-sm-inline" style="margin-left: 3px;">Logout</span>
              </a>
            </li>
            <li class="nav-item d-xl-none ps-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-white p-0" id="iconNavbarSidenav">
                <div class="sidenav-toggler-inner">
                  <i class="sidenav-toggler-line bg-white"></i>
                  <i class="sidenav-toggler-line bg-white"></i>
                  <i class="sidenav-toggler-line bg-white"></i>
                </div>
              </a>
            </li>
          </ul>
        </div>
    </nav>
    <!-- End Navbar -->
    <div class="container-fluid py-4">
      <div class="row">
        <div class="col-12">
          <div class="card mb-4">
            <div class="card-header pb-0" style="display: flex; justify-content: space-between;">
              <h6>{{ lesson_name }} <span class="text-uppercase text-sm" style="margin-left: 20px;">{{ lesson_date
                  }}</span></h6>
              <div>
                <!-- <div class="min-h-6 mb-0.5 flex items-center">
                  <input id="confirm-input" style="width: 2.5rem !important;"
                    class="rounded-10 duration-300 ease-in-out after:rounded-circle after:shadow-2xl after:duration-300 checked:after:translate-x-5.3 h-5 mt-0.5 relative float-left w-10 cursor-pointer appearance-none border border-solid border-gray-200 bg-slate-800/10 bg-none bg-contain bg-left bg-no-repeat align-top transition-all after:absolute after:top-px after:h-4 after:w-4 after:translate-x-px after:bg-white after:content-[''] checked:border-blue-500/95 checked:bg-blue-500/95 checked:bg-none checked:bg-right"
                    type="checkbox" checked>
                  <div class="ml-2">
                    <span class="block text-sm font-semibold leading-normal text-slate-700 dark:text-white">Are students
                      can leave before the end of the lesson</span>
                  </div>
                </div> -->
              </div>
              <div>
                <!-- {% if need_to_show_students_exits %} -->
                <!-- {% endif %} -->
                <button id="check-btn" class="btn bg-gradient-warning btn-sm ms-auto" onclick="show_exits();">Students
                  exits</button>
                {% if need_to_show_check_students_btn %}
                <button id="check-btn" class="btn bg-gradient-success btn-sm ms-auto"
                  onclick="checkStudentsForAbsence(this, Number('{{ lesson_id }}'), Number('{{ class_id}}'));">Check
                  students for absence</button>
                {% endif %}
                <button id="save-btn" class="btn btn-primary btn-sm ms-auto"
                  onclick="window.location.reload();">Reload</button>
              </div>
            </div>
            <div class="card-body px-0 pt-0 pb-2">
              <div class="row" style="padding-left: 24px;">
                <div class="col-md-6" style="width: 100%;">
                  <div class="form-check form-check-info text-start">
                    <input class="form-check-input" type="checkbox" id="flexCheckDefault" {% if can_students_leave
                      %}checked{% endif %} onchange="setCanStudentsLeave(this, '{{ lesson_id }}')">
                    <label class="form-check-label" for="flexCheckDefault">
                      Are students can leave before the end of the lesson
                    </label>
                  </div>
                </div>
              </div>
              <div class="table-responsive p-0">
                <table class="table align-items-center mb-0">
                  <thead>
                    <tr>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Name
                      </th>
                      <th colspan="{{ days_in_month|length }}"
                        class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">
                        {{ month_name }}</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td></td>
                      {% for i in days_in_month %}
                      {% if i[1] %}
                      <td class="text-uppercase text-warning text-xxs font-weight-bolder ps-2">{{ i[0] + 1 }}
                      </td>
                      {% else %}
                      <td class="text-uppercase text-secondary text-xxs font-weight-bolder ps-2">{{ i[0] + 1 }}</td>
                      {% endif %}
                      {% endfor %}
                    </tr>
                    {% for i in students %}
                    <tr>
                      <td>
                        <div class="d-flex px-2 py-1" onclick="location.href=`/profile/{{ i['id'] }}`"
                          style="cursor: pointer;">
                          <div>
                            <img src="{{ i['user_avatar_path'] }}" class="avatar avatar-sm me-3" alt="user1">
                          </div>
                          <div class="d-flex flex-column justify-content-center">
                            <h6 class="mb-0 text-sm">{{ i["name"] }}</h6>
                          </div>
                        </div>
                      </td>
                      {% for index, j in enumerate(i["marks"]) %}
                      <td class="text-xs font-weight-bold mb-0" style="text-align: -webkit-center;">
                        {% if j == "A" %}
                        <input type="text" class="mark-input form-control"
                          id="mark__{{ days_in_month[index][0] + 1 }}__{{ i['id'] }}" value="{{ j }}"
                          style="color: #ec0000; width: 35px; height: 35px;" maxlength="1" user_id="{{ i['id'] }}"
                          lesson_date="{{ lesson_date }}">
                        {% else %}
                        <input type="text" class="mark-input form-control"
                          id="mark__{{ days_in_month[index][0] + 1 }}__{{ i['id'] }}" value="{{ j }}"
                          style="width: 35px; height: 35px;" maxlength="1" user_id="{{ i['id'] }}"
                          lesson_date="{{ lesson_date }}">
                        {% endif %}
                      </td>
                      {% endfor %}
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="fixed-plugin" id="right-nav">
        <div class="exits-card card shadow-lg" id="card">
          <div class="card-header pb-0 pt-3 ">
            <div class="float-start">
              <h5 class="mt-3 mb-0"><span id="date-in-title">{{ lesson_date }}</span></h5>
            </div>
            <div class="float-end mt-4 exits_navbar_cross__div">
              <button class="btn btn-link text-dark p-0 fixed-plugin-close-button" id="exits_navbar_cross">
                <i class="fa fa-close"></i>
              </button>
            </div>
            <!-- End Toggle Button -->
          </div>
          <hr class="horizontal dark my-1">
          <div class="card-body pt-sm-3 pt-0 overflow-auto" id="card-body">
            <div>
              <table>
                <thead id="exits-thead">
                  <tr>
                    <th>Time</th>
                    <th>Status</th>
                    <th>Name</th>
                  </tr>
                </thead>
                <tbody id="exits-tbody">
                  <!-- <tr>
                    <td class="time-in-exits" in-exiting>00:10</td>
                    <td>
                      <div style="display: flex; justify-content: center;">
                        <lord-icon src="https://cdn.lordicon.com/qznlhdss.json" trigger="loop" colors="primary:#ffb647"
                          state="loop" style="width:24px;height:24px">
                        </lord-icon>
                      </div>
                    </td>
                    <td>Власов Григорий</td>
                  </tr>
                  <tr>
                    <td class="time-in-exits">01:30</td>
                    <td>
                      <div style="display: flex; justify-content: center;">
                        <img src="/static/img/entry.svg" alt="entry">
                      </div>
                    </td>
                    <td>Власов Григорий</td>
                  </tr> -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <footer class="pt-4">
          <div class="w-full px-6 mx-auto">
            <div class="flex flex-wrap items-center -mx-3 lg:justify-between">
              <div class="w-full max-w-full px-3 mt-0 mb-6 shrink-0 lg:mb-0 lg:w-1/2 lg:flex-none" style="width: 100%;">
                <div class="text-sm leading-normal text-center copyright text-slate-500 lg:text-left">
                  ©
                  <script>
                    document.write(new Date().getFullYear())
                  </script>,
                  made with <i class="fa fa-heart"></i> by
                  <a href="https://www.creative-tim.com" class="font-weight-bold" target="_blank">Creative Tim</a>
                  for a better web.
                </div>
              </div>
            </div>
          </div>
        </footer>
      </div>
    </div>
  </main>
  <!--   Core JS Files   -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="/static/js/core/popper.min.js"></script>
  <script src="/static/js/core/bootstrap.min.js"></script>
  <!-- <script src="/static/js/plugins/smooth-scrollbar.min.js"></script> -->
  <script src="/static/js/script.js"></script>
  <script>
    var win = navigator.platform.indexOf('Win') > -1;
    if (win && document.querySelector('#sidenav-scrollbar')) {
      var options = {
        damping: '0.5'
      }
      Scrollbar.init(document.querySelector('#sidenav-scrollbar'), options);
    }

    $('body').on('input', 'input.mark-input', function () {
      if (Number(this.value) == 2 || Number(this.value) == 3 || Number(this.value) == 4 || Number(this.value) == 5) {
        this.style.color = "#495057";
      } else if (this.value.toUpperCase() == "A") {
        this.value = this.value.toUpperCase();
        this.style.color = "#ec0000";
      } else {
        this.value = "";
      }

      saveStudentMark(this.getAttribute("user_id"), Number("{{ lesson_id }}"), this.getAttribute("lesson_date"), this.value)
    });


    var is_shown = false;

    function show_exits() {
      console.log("Open!")
      is_shown = true;

      hide_body_overflow();
      document.getElementById("card-body").scrollTo(pageXOffset, 0);
      setTimeout(function () { document.getElementById("right-nav").classList.add("show"); });
    };


    function update_local_time() {
      for (var i of document.getElementsByClassName("time-in-exits")) {
        if (i.getAttribute("in-exiting") === null) {
          continue;
        }

        if (i.innerHTML.trim().split(":").length == 2) {
          var datetime = new Date(`July 1, 1999, 00:${i.innerHTML.trim()}`);
        } else {
          var datetime = new Date(`July 1, 1999, ${i.innerHTML.trim()}`);
        }
        datetime.setTime(datetime.getTime() + 1000);

        var hours = String(datetime.getHours());
        if (hours.length == 1) {
          hours = "0" + hours;
        }
        var minutes = String(datetime.getMinutes());
        if (minutes.length == 1) {
          minutes = "0" + minutes;
        }
        var seconds = String(datetime.getSeconds());
        if (seconds.length == 1) {
          seconds = "0" + seconds;
        }
        if (hours == "00") {
          i.innerHTML = `${minutes}:${seconds}`
        } else {
          i.innerHTML = `${hours}:${minutes}:${seconds}`
        }
      }
    }


    function update_table(data) {
      var innerHTML = "";
      for (var i of data) {
        var now_datetime = new Date();
        var now_timestamp = (new Date(`July 1, 1999, ${now_datetime.getHours()}:${now_datetime.getMinutes()}:${now_datetime.getSeconds()}`)).getTime();
        var exit_timestamp = (new Date(`July 1, 1999, ${i["exit_date"]}`)).getTime();
        var new_time = new Date("July 1, 1999 00:00:00");
        if (i["event"] === "exit") {
          new_time.setTime(930772800000 + (now_timestamp - exit_timestamp));
        } else {
          var entry_timestamp = (new Date(`July 1, 1999, ${i["entry_date"]}`)).getTime();
          new_time.setTime(930772800000 + (entry_timestamp - exit_timestamp));
        }

        var hours = String(new_time.getHours());
        if (hours.length == 1) {
          hours = "0" + hours;
        }
        var minutes = String(new_time.getMinutes());
        if (minutes.length == 1) {
          minutes = "0" + minutes;
        }
        var seconds = String(new_time.getSeconds());
        if (seconds.length == 1) {
          seconds = "0" + seconds;
        }
        if (hours == "00") {
          var time = `${minutes}:${seconds}`
        } else {
          var time = `${hours}:${minutes}:${seconds}`
        }

        if (i["event"] === "exit") {
          innerHTML += `<tr><td class="time-in-exits" in-exiting>${time}</td>
                  <td><div style="display: flex; justify-content: center;"><lord-icon src="https://cdn.lordicon.com/qznlhdss.json" trigger="loop" colors="primary:#ffb647" state="loop" style="width:24px;height:24px"></lord-icon></div></td>
                  <td>${i["user_name"]}</td></tr>`
        } else {
          innerHTML += `<tr><td class="time-in-exits">${time}</td>
                  <td><div style="display: flex; justify-content: center;"><img src="/static/img/entry.svg" alt="entry"></div></td>
                  <td>${i["user_name"]}</td></tr>`
        }
      }
      document.getElementById("exits-tbody").innerHTML = innerHTML;
    }

    async function update_server_time() {
      await fetch('/api/get_exits_data/{{ lesson_id }}/{{ class_id }}/{{ _lesson_date }}/', {
        method: 'POST',
      })
        .then(response => response.json())
        .then(data => {
          console.log(`Updated (${data.length} students)`);
          update_table(data);
        })
        .catch(error => {
          console.error(error);
        })
    }
    update_table({{ exits_data| safe }});
    if ("{{ need_to_show_students_exits }}" === "True") {
      setInterval(update_local_time, 1000);
      setInterval(update_server_time, 5000);
    }


    document.getElementById("card").onclick = function () {
      if (document.getElementById("right-nav").classList.contains("show")) {
        console.log("Card");
        is_shown = true;
      }
    };

    document.getElementById("exits_navbar_cross").onclick = function () {
      document.getElementById("right-nav").classList.remove('show');
      document.body.style.overflow = "";
      console.log("Close button");
    };

    document.getElementsByTagName("body")[0].onclick = function () {
      console.log("Body");
      if (!is_shown) {
        document.getElementById("right-nav").classList.remove('show');
        document.body.style.overflow = "";
      }
      is_shown = false;
    };
  </script>
  <script src="/static/js/argon-dashboard.min.js?v=2.0.4"></script>
</body>

</html>